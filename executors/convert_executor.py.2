import os
from flaskr.modelos import Tarea, db
import smtplib

from flaskr.modelos.modelos import Usuario


class Convert:
    @staticmethod
    def pending_tasks() -> [Tarea]:
        return db.session.query(Tarea).filter(Tarea.status == 'UPLOADED').all()

    def run(self):
        tasks = self.pending_tasks()
        if tasks:
            for t in tasks:
                #newfile = str(t.file[:-3]) + str(t.newformat)
                command = 'ffmpeg -i ' + str(t.file) + ' ' + str(t.newformat)
                try:
                    os.system(command)
                    #if enviarCorreo(t.usuario_id. newfile):
                       # t.status = 'PROCESSED'
                    print("Conversión realizada con exito")
                except Exception as e:
                    print(e)
            print(f'{len(tasks)} Tareas ejecutadas')
        else:
            print(f'No hay tareas por hacer')


def enviarCorreo(usuario_id, nombreArchivo):
    usuario = db.session.query(Usuario).filter(Usuario.id == usuario_id).all()
    ## DATOS CORREO
    user = "grupo21.conversor@outlook.com" 
    password = "Grupo211357"

    to = [usuario.correo]
    from_email = "CONVERSOR"
    subject = "Archivo procesado\n"

    ## MENSAJE
    msg = ("Se ha procesado el archivo y se ha convertido al nuevo formato"
            " descarguelo dando clic aqui "
            "http://172.23.66.31:8080/api/files/" + nombreArchivo)

    try:
        for destination in to: 
            ## REALIZAR CONEXIÓN AL CORREO
            smtpserver = smtplib.SMTP("smtp.office365.com",587)
            smtpserver.ehlo()
            smtpserver.starttls()
            smtpserver.ehlo()
            smtpserver.login(user, password)

            ## REDACCIÓN DEL CORREO
            ## CABECERA
            header = "To:" + destination + "\n" + "From: " + from_email + "\n" + "Subject:" + subject + "\n"

            ## MENSAJE
            mail = header + msg

            ## ENVIÓ
            smtpserver.sendmail(user, destination, mail)
            smtpserver.close()			
            return True
        
    except Exception as e:
        print("ERROR EN EL ENVIÓ DEL CORREO", e)
        return False
